# Continuous Integration Workflow
#
# Main CI pipeline that runs comprehensive checks on all code changes.
# This workflow ensures code quality, correctness, and security before merging.
#
# Runs on:
#   - Push to main branch
#   - Pull requests to main
#
# Jobs:
#   - check: Code formatting (rustfmt) and linting (clippy) with and without features
#   - test: Unit and integration tests with and without features
#   - deny: Security audits, license checks, and dependency validation
#   - docker: Docker image build and smoke test with health check
#
# Features:
#   - Rust toolchain caching for faster builds
#   - Strict clippy warnings enforced
#   - Docker health check with retry logic
#   - Locked dependency resolution for reproducibility

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Daily security audit at noon UTC to catch new CVEs
    - cron: '0 12 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        # Rust version controlled by rust-toolchain.toml in repository root (currently 1.88.0)
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          components: clippy, rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@5cb072d7354962be830356aa6b146f7612846014 # v2.7.5

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy (default features)
        run: cargo clippy --locked --all-targets -- -D warnings

      - name: Run clippy (all features)
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        # Rust version controlled by rust-toolchain.toml in repository root (currently 1.88.0)
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@5cb072d7354962be830356aa6b146f7612846014 # v2.7.5

      - name: Run tests (default features)
        run: cargo test --locked

      - name: Run tests (all features)
        run: cargo test --locked --all-features

  deny:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # This job handles all security audits including vulnerabilities (cargo-audit),
    # licenses, banned dependencies, and source verification (cargo-deny).
    # Runs on push/PR and daily via schedule (see workflow triggers).
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@44db170f6a7d12a6e90340e9e0fca1f650d34b14 # v2.0.15
        with:
          arguments: --all-features

  msrv:
    name: MSRV Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Verify Minimum Supported Rust Version (MSRV) compliance
    # This job catches future regressions when dependencies require newer Rust versions
    # MSRV is the single source of truth defined in Cargo.toml and must be consistent
    # across all configuration files (rust-toolchain.toml, clippy.toml, Dockerfile, etc.)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Extract MSRV from Cargo.toml
        id: msrv
        run: |
          # Extract rust-version field from Cargo.toml as the canonical MSRV
          MSRV=$(grep '^rust-version = ' Cargo.toml | sed -E 's/rust-version = "(.+)"/\1/')
          if [ -z "$MSRV" ]; then
            echo "ERROR: Could not extract rust-version from Cargo.toml"
            exit 1
          fi
          echo "msrv=$MSRV" >> "$GITHUB_OUTPUT"
          echo "Extracted MSRV: $MSRV"

      - name: Verify MSRV consistency across configuration files
        run: |
          set -euo pipefail
          MSRV="${{ steps.msrv.outputs.msrv }}"

          # Track failures
          FAILED=0

          echo "Verifying MSRV consistency: $MSRV"
          echo "=========================================="

          # Check rust-toolchain.toml
          if [ -f rust-toolchain.toml ]; then
            TOOLCHAIN_VERSION=$(grep '^channel = ' rust-toolchain.toml | sed -E 's/channel = "(.+)"/\1/')
            if [ "$TOOLCHAIN_VERSION" != "$MSRV" ]; then
              echo "✗ FAIL: rust-toolchain.toml channel=$TOOLCHAIN_VERSION (expected $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: rust-toolchain.toml"
            fi
          else
            echo "✗ FAIL: rust-toolchain.toml not found"
            FAILED=1
          fi

          # Check clippy.toml
          if [ -f clippy.toml ]; then
            CLIPPY_MSRV=$(grep '^msrv = ' clippy.toml | sed -E 's/msrv = "(.+)"/\1/')
            if [ "$CLIPPY_MSRV" != "$MSRV" ]; then
              echo "✗ FAIL: clippy.toml msrv=$CLIPPY_MSRV (expected $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: clippy.toml"
            fi
          else
            echo "⚠ WARNING: clippy.toml not found"
          fi

          # Check Dockerfile
          if [ -f Dockerfile ]; then
            # Extract Rust version from FROM rust:X.Y line (handles both 1.88 and 1.88.0 formats)
            DOCKERFILE_RUST=$(grep '^FROM rust:' Dockerfile | head -1 | sed -E 's/FROM rust:([0-9]+\.[0-9]+).*/\1/')
            # Normalize MSRV to major.minor for comparison (1.88.0 -> 1.88)
            # Docker images use shortened versions (rust:1.88) while MSRV uses full semver (1.88.0)
            MSRV_SHORT=$(echo "$MSRV" | sed -E 's/([0-9]+\.[0-9]+).*/\1/')
            if [ "$DOCKERFILE_RUST" != "$MSRV_SHORT" ]; then
              echo "✗ FAIL: Dockerfile rust:$DOCKERFILE_RUST (expected rust:$MSRV_SHORT from MSRV $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: Dockerfile"
            fi
          else
            echo "⚠ WARNING: Dockerfile not found"
          fi

          echo "=========================================="

          if [ $FAILED -ne 0 ]; then
            echo ""
            echo "ERROR: MSRV inconsistency detected!"
            echo "All configuration files must use the same Rust version as Cargo.toml"
            echo "Expected MSRV: $MSRV"
            echo ""
            echo "To fix:"
            echo "1. Update rust-toolchain.toml: channel = \"$MSRV\""
            echo "2. Update clippy.toml: msrv = \"$MSRV\""
            echo "3. Update Dockerfile: FROM rust:$MSRV-bookworm"
            echo ""
            echo "See .llm/skills/msrv-and-toolchain-management.md for details"
            exit 1
          fi

          echo "All MSRV configuration checks passed ✓"

      - name: Install Rust toolchain at MSRV
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          toolchain: ${{ steps.msrv.outputs.msrv }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@5cb072d7354962be830356aa6b146f7612846014 # v2.7.5
        with:
          # Separate cache key for MSRV job to avoid conflicts with main CI
          prefix-key: "msrv"

      - name: Verify build with MSRV
        run: |
          cargo check --locked --all-targets
          echo "✓ Code compiles successfully with MSRV ${{ steps.msrv.outputs.msrv }}"

      - name: Verify tests with MSRV
        run: |
          cargo test --locked --all-features --no-fail-fast
          echo "✓ All tests pass with MSRV ${{ steps.msrv.outputs.msrv }}"

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Build Docker image
        run: docker build -t signal-fish-server:ci .

      - name: Smoke test
        run: |
          docker run -d --name test-server -p 3536:3536 signal-fish-server:ci
          # Retry health check with exponential backoff (up to ~30s)
          for i in $(seq 1 15); do
            if curl -sf http://localhost:3536/v2/health; then
              echo ""
              echo "Health check passed on attempt $i/15"
              exit 0
            fi
            echo "Attempt $i/15: server not ready, retrying in 2s..."
            sleep 2
          done
          echo "ERROR: Server failed to become healthy after 30s"
          echo "=== Docker logs ==="
          docker logs test-server
          exit 1

      - name: Cleanup smoke test
        if: always()
        run: docker stop test-server && docker rm test-server || true
