# Continuous Integration Workflow
#
# Main CI pipeline that runs comprehensive checks on all code changes.
# This workflow ensures code quality, correctness, and security before merging.
#
# Runs on:
#   - Push to main branch
#   - Pull requests to main
#
# Jobs:
#   - lint: Cross-OS code formatting (rustfmt) and linting (clippy) matrix
#   - nextest: Cross-OS test execution via cargo-nextest (doc-tests in doc-validation.yml)
#   - deny: Security audits, license checks, and dependency validation
#   - docker: Docker image build and smoke test with health check
#   - coverage: Linux code coverage gate via cargo-llvm-cov
#   - panic-policy: Zero-panic production code enforcement
#   - sbom: Software Bill of Materials generation (CycloneDX JSON)
#
# Features:
#   - Rust toolchain caching for faster builds
#   - Strict clippy warnings enforced
#   - Docker health check with exponential backoff retry
#   - Locked dependency resolution for reproducibility
#   - Nextest configuration via .config/nextest.toml

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Daily security audit at noon UTC to catch new CVEs
    - cron: '0 12 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        # Rust version controlled by rust-toolchain.toml in repository root (currently 1.88.0)
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          components: clippy, rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

  nextest:
    name: Nextest (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        # Rust version controlled by rust-toolchain.toml in repository root (currently 1.88.0)
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Install cargo-nextest
        uses: taiki-e/install-action@f92912fad184299a31e22ad070a5059fd07d4f59 # v2
        with:
          tool: cargo-nextest

      - name: Run nextest
        # nextest does not support doc-tests; those are validated by doc-validation.yml
        run: cargo nextest run --locked --all-features

  deny:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # This job handles all security audits including vulnerabilities (cargo-audit),
    # licenses, banned dependencies, and source verification (cargo-deny).
    # Runs on push/PR and daily via schedule (see workflow triggers).
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2.0.15
        with:
          arguments: --all-features
        env:
          # Override rust-toolchain.toml inside the cargo-deny Docker container.
          # The container ships its own Rust toolchain and does not have our pinned
          # version (1.88.0) installed. RUSTUP_TOOLCHAIN takes precedence over the
          # toolchain file, preventing the "uninstalled toolchain" error.
          # cargo-deny only inspects metadata and Cargo.lock — it does not compile
          # code, so the exact Rust version is irrelevant.
          RUSTUP_TOOLCHAIN: stable

  msrv:
    name: MSRV Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Verify Minimum Supported Rust Version (MSRV) compliance
    # This job catches future regressions when dependencies require newer Rust versions
    # MSRV is the single source of truth defined in Cargo.toml and must be consistent
    # across all configuration files (rust-toolchain.toml, clippy.toml, Dockerfile, etc.)
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract MSRV from Cargo.toml
        id: msrv
        run: |
          # Extract rust-version field from Cargo.toml as the canonical MSRV
          MSRV=$(grep '^rust-version = ' Cargo.toml | sed -E 's/rust-version = "(.+)"/\1/')
          if [ -z "$MSRV" ]; then
            echo "ERROR: Could not extract rust-version from Cargo.toml"
            exit 1
          fi
          echo "msrv=$MSRV" >> "$GITHUB_OUTPUT"
          echo "Extracted MSRV: $MSRV"

      - name: Verify MSRV consistency across configuration files
        run: |
          set -euo pipefail
          MSRV="${{ steps.msrv.outputs.msrv }}"

          # Track failures
          FAILED=0

          echo "Verifying MSRV consistency: $MSRV"
          echo "=========================================="

          # Check rust-toolchain.toml
          if [ -f rust-toolchain.toml ]; then
            TOOLCHAIN_VERSION=$(grep '^channel = ' rust-toolchain.toml | sed -E 's/channel = "(.+)"/\1/')
            if [ "$TOOLCHAIN_VERSION" != "$MSRV" ]; then
              echo "✗ FAIL: rust-toolchain.toml channel=$TOOLCHAIN_VERSION (expected $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: rust-toolchain.toml"
            fi
          else
            echo "✗ FAIL: rust-toolchain.toml not found"
            FAILED=1
          fi

          # Check clippy.toml
          if [ -f clippy.toml ]; then
            CLIPPY_MSRV=$(grep '^msrv = ' clippy.toml | sed -E 's/msrv = "(.+)"/\1/')
            if [ "$CLIPPY_MSRV" != "$MSRV" ]; then
              echo "✗ FAIL: clippy.toml msrv=$CLIPPY_MSRV (expected $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: clippy.toml"
            fi
          else
            echo "⚠ WARNING: clippy.toml not found"
          fi

          # Check Dockerfile
          if [ -f Dockerfile ]; then
            # Extract Rust version from FROM rust:X.Y line (handles both 1.88 and 1.88.0 formats)
            DOCKERFILE_RUST=$(grep '^FROM rust:' Dockerfile | head -1 | sed -E 's/FROM rust:([0-9]+\.[0-9]+).*/\1/')
            # Normalize MSRV to major.minor for comparison (1.88.0 -> 1.88)
            # Docker images use shortened versions (rust:1.88) while MSRV uses full semver (1.88.0)
            MSRV_SHORT=$(echo "$MSRV" | sed -E 's/([0-9]+\.[0-9]+).*/\1/')
            if [ "$DOCKERFILE_RUST" != "$MSRV_SHORT" ]; then
              echo "✗ FAIL: Dockerfile rust:$DOCKERFILE_RUST (expected rust:$MSRV_SHORT from MSRV $MSRV)"
              FAILED=1
            else
              echo "✓ PASS: Dockerfile"
            fi
          else
            echo "⚠ WARNING: Dockerfile not found"
          fi

          echo "=========================================="

          if [ $FAILED -ne 0 ]; then
            echo ""
            echo "ERROR: MSRV inconsistency detected!"
            echo "All configuration files must use the same Rust version as Cargo.toml"
            echo "Expected MSRV: $MSRV"
            echo ""
            echo "To fix:"
            echo "1. Update rust-toolchain.toml: channel = \"$MSRV\""
            echo "2. Update clippy.toml: msrv = \"$MSRV\""
            echo "3. Update Dockerfile: FROM rust:$MSRV-bookworm"
            echo ""
            echo "See .llm/skills/msrv-and-toolchain-management.md for details"
            exit 1
          fi

          echo "All MSRV configuration checks passed ✓"

      - name: Install Rust toolchain at MSRV
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          toolchain: ${{ steps.msrv.outputs.msrv }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5
        with:
          # Separate cache key for MSRV job to avoid conflicts with main CI
          prefix-key: "msrv"

      - name: Verify build and tests with MSRV
        run: |
          cargo test --locked --all-features --no-fail-fast
          echo "✓ Build and tests successful with MSRV ${{ steps.msrv.outputs.msrv }}"

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build Docker image
        run: docker build -t signal-fish-server:ci .

      - name: Smoke test
        run: |
          docker run -d --name test-server -p 3536:3536 signal-fish-server:ci
          # Exponential backoff health check: 1s, 2s, 4s, 8s, 8s (max 23s total wait)
          DELAY=1
          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:3536/v2/health > /dev/null 2>&1; then
              echo "Health check passed on attempt $i/5"
              exit 0
            fi
            echo "Attempt $i/5: server not ready, retrying in ${DELAY}s..."
            sleep "$DELAY"
            DELAY=$((DELAY * 2))
            [ "$DELAY" -gt 8 ] && DELAY=8
          done
          echo "ERROR: Server failed to become healthy"
          echo "=== Docker logs ==="
          docker logs test-server
          exit 1

      - name: Cleanup smoke test
        if: always()
        run: docker stop test-server && docker rm test-server || true

  coverage:
    name: Coverage (llvm-cov)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@f92912fad184299a31e22ad070a5059fd07d4f59 # v2
        with:
          tool: cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Enforce coverage threshold
        run: cargo llvm-cov report --fail-under-lines 70

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 14

  panic-policy:
    name: Panic Policy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        # Rust version controlled by rust-toolchain.toml in repository root (currently 1.88.0)
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Run panic-policy check
        run: ./scripts/check-no-panics.sh

  sbom:
    name: SBOM (CycloneDX)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Install cargo-sbom
        uses: taiki-e/install-action@f92912fad184299a31e22ad070a5059fd07d4f59 # v2
        with:
          tool: cargo-sbom

      - name: Generate SBOM (CycloneDX)
        run: cargo sbom --output-format cyclone_dx_json_1_5 > sbom.cdx.json

      - name: Upload SBOM artifact
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom-cyclonedx-${{ github.sha }}
          path: sbom.cdx.json
          retention-days: 90
