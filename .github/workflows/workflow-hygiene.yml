# Workflow Hygiene Validation
#
# Validates GitHub Actions workflow files for common issues and misconfigurations.
# This workflow was created to prevent recurrence of three actual CI issues:
#   1. Python cache setup on non-Python project (yaml-lint.yml)
#   2. Nightly toolchain becoming stale (>360 days old)
#   3. Dependencies not actually used in code
#
# Runs on:
#   - Push to main branch (only for workflow file changes)
#   - Pull requests to main (only for workflow file changes)
#   - Weekly schedule (Monday at 06:00 UTC) for proactive staleness detection
#
# Features:
#   - Language-specific caching validation (no Python cache on Rust projects)
#   - Nightly toolchain staleness detection (warns at 180 days, errors at 365 days)
#   - Workflow self-validation infrastructure checks
#   - Dependency audit workflow presence validation
#   - Timeout configuration checks
#   - GitHub Actions version pinning validation

name: Workflow Hygiene

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - 'scripts/check-workflow-hygiene.sh'
      - '.github/workflows/workflow-hygiene.yml'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - 'scripts/check-workflow-hygiene.sh'
      - '.github/workflows/workflow-hygiene.yml'
  schedule:
    # Run weekly on Monday at 06:00 UTC to detect stale nightly toolchains
    - cron: '0 6 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  workflow-hygiene:
    name: Validate Workflow Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run workflow hygiene checks
        run: ./scripts/check-workflow-hygiene.sh

      - name: Summary
        if: always()
        run: |
          echo "Workflow hygiene validation completed."
          echo ""
          echo "This check validates:"
          echo "  - Language-specific caching matches project type"
          echo "  - Nightly toolchains are not stale (< 6 months)"
          echo "  - Workflows have self-validation infrastructure"
          echo "  - Dependency audit workflows are present"
          echo "  - Jobs have timeout configurations"
          echo "  - GitHub Actions are pinned to SHA hashes"
