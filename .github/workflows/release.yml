# Release Workflow - Publish Crate and Create GitHub Release
#
# Publishes the crate to crates.io and creates a GitHub Release with changelog.
#
# Runs on:
#   - Manual workflow dispatch (with version input)
#   - Tag pushes matching v* pattern
#
# Steps:
#   1. Verify version consistency (tag vs Cargo.toml)
#   2. Dry-run publish to validate packaging
#   3. Publish to crates.io
#   4. Create git tag (for workflow_dispatch)
#   5. Extract changelog section and create GitHub Release

name: Release - Publish Crate

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Version to publish, e.g. 0.1.0 (must match Cargo.toml, no 'v' prefix)"
        required: true
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          toolchain: stable

      - name: Configure sccache
        id: sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
        continue-on-error: true

      - name: Verify sccache is working
        id: sccache-check
        if: steps.sccache.outcome == 'success'
        run: |
          if sccache --show-stats > /dev/null 2>&1; then
            echo "working=true" >> "$GITHUB_OUTPUT"
            echo "sccache is operational"
          else
            echo "working=false" >> "$GITHUB_OUTPUT"
            echo "sccache binary not responding"
          fi
        continue-on-error: true

      - name: Clear sccache env on failure
        if: steps.sccache.outcome != 'success' || steps.sccache-check.outcome != 'success'
        run: |
          echo "RUSTC_WRAPPER=" >> "$GITHUB_ENV"
          echo "SCCACHE_GHA_ENABLED=" >> "$GITHUB_ENV"

      - name: Cache cargo registry and build
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: publish-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            publish-${{ runner.os }}-cargo-

      - name: Verify version consistency
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          echo "Cargo.toml version: $CARGO_VERSION"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_VERSION="${{ github.event.inputs.release_version }}"
            if [ "$INPUT_VERSION" != "$CARGO_VERSION" ]; then
              echo "Input version $INPUT_VERSION does not match Cargo.toml version $CARGO_VERSION" >&2
              exit 1
            fi
            echo "Input version matches Cargo.toml"
          fi

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/}
            if [ "$TAG_VERSION" != "v${CARGO_VERSION}" ]; then
              echo "Tag version $TAG_VERSION does not match Cargo.toml version $CARGO_VERSION" >&2
              exit 1
            fi
            echo "Tag version matches Cargo.toml"
          fi

      - name: Publish (dry-run)
        run: cargo publish --dry-run
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.working == 'true' && 'sccache' || '' }}
          SCCACHE_GHA_ENABLED: ${{ steps.sccache-check.outputs.working == 'true' && 'true' || 'false' }}
          SCCACHE_IGNORE_SERVER_IO_ERROR: "1"
          SCCACHE_STARTUP_NOTIFY_TIMEOUT: "60"
          SCCACHE_IDLE_TIMEOUT: "0"

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish

      - name: Create and push git tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          TAG_NAME="v${CARGO_VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Get version for release
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for release
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## [X.Y.Z]" until the next "## [" or end of file
          CHANGELOG_CONTENT=$(awk -v ver="$VERSION" '
            BEGIN { found=0; printing=0 }
            /^## \[/ {
              if (printing) { exit }
              if ($0 ~ "\\[" ver "\\]") { found=1; printing=1; next }
            }
            printing { print }
          ' CHANGELOG.md)

          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Release $VERSION"
          fi

          # Write to file to preserve newlines
          echo "$CHANGELOG_CONTENT" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: ${{ steps.get_version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
