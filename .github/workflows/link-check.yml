# Link Checking Workflow
#
# Validates all links in documentation and code to catch broken URLs and link rot.
# Uses lychee for fast, comprehensive link checking including external URLs, internal
# links, and anchor references.
#
# Configuration:
#   - .lychee.toml: Link checker configuration and exclusions
#
# Runs on:
#   - Push to main branch (only for relevant file changes)
#   - Pull requests to main (only for relevant file changes)
#   - Weekly schedule (Monday at 00:00 UTC) for proactive link rot detection
#
# Features:
#   - Checks external URLs, internal links, and anchors
#   - Built-in caching to reduce API rate limiting
#   - Automatic retry logic for transient failures
#   - GitHub token to avoid rate limiting on GitHub links

name: Link Check

on:
  push:
    branches: [main]
    paths:
      - '**/*.md'
      - '**/*.rs'
      - '**/*.toml'
      - '.lychee.toml'
      - '.github/workflows/link-check.yml'
  pull_request:
    branches: [main]
    paths:
      - '**/*.md'
      - '**/*.rs'
      - '**/*.toml'
      - '.lychee.toml'
      - '.github/workflows/link-check.yml'
  schedule:
    # Run weekly on Monday at 00:00 UTC to catch link rot
    - cron: '0 0 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Link Checker
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2.7.0
        with:
          # Note: --cache flag enables caching with 7-day max age
          args: --verbose --no-progress --cache --max-cache-age 7d './**/*.md' './**/*.rs' './**/*.toml' --config .lychee.toml
          fail: true
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
