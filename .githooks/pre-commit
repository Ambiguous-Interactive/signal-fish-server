#!/bin/sh
# Pre-commit hook for Signal Fish Server
# Runs code formatting and panic-prone pattern checks before each commit.
#
# To install: ./scripts/enable-hooks.sh
# To bypass (not recommended): git commit --no-verify

set -e

echo "[pre-commit] Running pre-commit checks..."

# Check code formatting
echo "[pre-commit] Checking code formatting..."
if ! cargo fmt --check 2>/dev/null; then
    echo "[pre-commit] ERROR: Code is not formatted. Run 'cargo fmt' and try again."
    exit 1
fi

# Check for panic-prone patterns (fast pattern scan only)
echo "[pre-commit] Checking for panic-prone patterns..."
if [ -x scripts/check-no-panics.sh ]; then
    if ! scripts/check-no-panics.sh patterns; then
        echo "[pre-commit] ERROR: Panic-prone patterns detected. Fix them and try again."
        exit 1
    fi
fi

# Check markdown files (if markdownlint-cli2 is installed)
if command -v markdownlint-cli2 >/dev/null 2>&1; then
    echo "[pre-commit] Checking markdown files..."
    if ! scripts/check-markdown.sh 2>&1 | grep -q "All markdown files are valid"; then
        echo "[pre-commit] ERROR: Markdown linting failed. Run './scripts/check-markdown.sh' for details."
        echo "[pre-commit] To auto-fix: ./scripts/check-markdown.sh fix"
        exit 1
    fi
else
    echo "[pre-commit] Skipping markdown check (markdownlint-cli2 not installed)"
fi

echo "[pre-commit] All checks passed."
