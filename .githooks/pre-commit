#!/bin/sh
# Pre-commit hook for Signal Fish Server
# Runs code formatting and panic-prone pattern checks before each commit.
#
# To install: ./scripts/enable-hooks.sh
# To bypass (not recommended): git commit --no-verify

set -e

echo "[pre-commit] Running pre-commit checks..."

# Check code formatting
echo "[pre-commit] Checking code formatting..."
if ! cargo fmt --check 2>/dev/null; then
    echo "[pre-commit] ERROR: Code is not formatted. Run 'cargo fmt' and try again."
    exit 1
fi

# Check for panic-prone patterns (fast pattern scan only)
echo "[pre-commit] Checking for panic-prone patterns..."
if [ -x scripts/check-no-panics.sh ]; then
    if ! scripts/check-no-panics.sh patterns; then
        echo "[pre-commit] ERROR: Panic-prone patterns detected. Fix them and try again."
        exit 1
    fi
fi

# Check markdown files (if markdownlint-cli2 is installed)
if command -v markdownlint-cli2 >/dev/null 2>&1; then
    echo "[pre-commit] Checking markdown files..."
    if ! scripts/check-markdown.sh 2>&1 | grep -q "All markdown files are valid"; then
        echo "[pre-commit] ERROR: Markdown linting failed. Run './scripts/check-markdown.sh' for details."
        echo "[pre-commit] To auto-fix: ./scripts/check-markdown.sh fix"
        exit 1
    fi
else
    echo "[pre-commit] Skipping markdown check (markdownlint-cli2 not installed)"
fi

# Check links in modified markdown files (if lychee is installed)
# Only check staged files to keep this fast
if command -v lychee >/dev/null 2>&1; then
    echo "[pre-commit] Checking links in staged markdown files..."
    STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)
    if [ -n "$STAGED_MD_FILES" ]; then
        # Use a temporary file to avoid issues with filenames containing spaces
        TEMP_FILE=$(mktemp)
        echo "$STAGED_MD_FILES" > "$TEMP_FILE"
        # Run lychee with fast settings (no network checks by default in pre-commit)
        # Use --offline flag to skip network checks for speed
        if ! xargs -a "$TEMP_FILE" lychee --offline --quiet --config .lychee.toml 2>/dev/null; then
            echo "[pre-commit] WARNING: Link check found issues in staged markdown files."
            echo "[pre-commit] This is a warning only. Run 'lychee --config .lychee.toml <file>' to check."
            # Non-blocking warning - don't exit 1
        fi
        rm -f "$TEMP_FILE"
    fi
else
    echo "[pre-commit] Skipping link check (lychee not installed)"
    echo "[pre-commit] Install with: cargo install lychee"
fi

echo "[pre-commit] All checks passed."
